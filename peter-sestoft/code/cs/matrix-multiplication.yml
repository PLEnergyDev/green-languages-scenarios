name: matrix-multiplication
language: cs
code: |
    using System;
    using System.Runtime.InteropServices;

    public class Program {
        [DllImport("libsignals", EntryPoint = "start_gl")]
        public static extern bool start_gl();

        [DllImport("libsignals", EntryPoint = "end_gl")]
        public static extern void end_gl();

        static void run_benchmark(string[] args) {
            int n = int.Parse(args[0]);
            int repetitions = (args.Length > 1) ? int.Parse(args[1]) : 1000;

            double[] A = new double[n * n];
            double[] B = new double[n * n];
            double[] C = new double[n * n];

            for (int i = 0; i < n; i++) {
                for (int j = 0; j < n; j++) {
                    A[i*n + j] = B[i*n + j] = i + j;
                }
            }

            double totalResult = 0.0;
            for (int rep = 0; rep < repetitions; rep++) {
                for (int i = 0; i < n; i++) {
                    for (int j = 0; j < n; j++) {
                        double sum = 0.0;
                        for (int k = 0; k < n; k++) {
                            sum += A[i*n + k] * B[k*n + j];
                        }
                        C[i*n + j] = sum;
                    }
                }
                totalResult += C[n*n - 1];
            }

            Console.WriteLine($"{totalResult / repetitions:F0}");
        }

        public static void Main(string[] args) {
            while (true) {
                if (!start_gl()) break;
                run_benchmark(args);
                end_gl();
            }
        }
    }
framework: net9.0
compile_options:
    - -c Release
    - -p:ImplicitUsings=enable
    - -p:Nullable=enable
    - -p:AllowUnsafeBlocks=true
    - -p:ServerGarbageCollection=true
    - -p:ConcurrentGarbageCollection=true
    - -p:UseSharedCompilation=false
    - -p:OptimizationPreference=Speed
    - -p:IlcInstructionSet=native
arguments: [200, 1000]
expected_stdout: !!binary MTg0ODcxMDAK
niceness: -20
affinity: [5]
---
name: release
mode: internal
---
name: release
mode: external
