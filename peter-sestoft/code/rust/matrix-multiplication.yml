name: matrix-multiplication
language: rust
code: |
    #[link(name = "signals")]
    unsafe extern "C" {
        fn start_gl() -> bool;
        fn end_gl();
    }

    fn run_benchmark(args: &[String]) {
        let n: usize = args.get(0)
            .expect("Missing argument")
            .parse()
            .expect("Invalid integer");
        let repetitions: usize = args.get(1)
            .map(|s| s.parse().expect("Invalid integer"))
            .unwrap_or(1000);

        let mut a = vec![0.0; n * n];
        let mut b = vec![0.0; n * n];
        let mut c = vec![0.0; n * n];

        for i in 0..n {
            for j in 0..n {
                let val = (i + j) as f64;
                a[i * n + j] = val;
                b[i * n + j] = val;
            }
        }

        let mut result = 0.0;
        for _ in 0..repetitions {
            for i in 0..n {
                for j in 0..n {
                    let mut sum = 0.0;
                    for k in 0..n {
                        sum += a[i * n + k] * b[k * n + j];
                    }
                    c[i * n + j] = sum;
                }
            }
            result += c[n * n - 1];
        }

        println!("{:.0}", result / repetitions as f64);
    }

    fn main() {
        let args: Vec<String> = std::env::args().skip(1).collect();
        loop {
            unsafe {
                if !start_gl() {
                    break;
                }
            }
            run_benchmark(&args);
            unsafe {
                end_gl();
            }
        }
    }
arguments: [200, 1000]
compile_options: [--release]
expected_stdout: !!binary MTg0ODcxMDAK
niceness: -20
affinity: [5]
---
name: release
mode: internal
---
name: release
mode: external
