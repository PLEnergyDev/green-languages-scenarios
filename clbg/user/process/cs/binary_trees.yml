name: binary-trees
language: cs
code: | # https://benchmarksgame-team.pages.debian.net/benchmarksgame/program/binarytrees-csharpaot-2.html
    // The Computer Language Benchmarks Game
    // https://benchmarksgame-team.pages.debian.net/benchmarksgame/
    //
    // based Jarkko Miettinen Java #2 and Anthony Lloyd C#
    // contributed by Isaac Gouy

    using System;
    using System.Threading.Tasks;

    class Program
    {
        const int MinDepth = 4;
        const int NoTasks = 4;

        public static void Main(string[] args)
        {
            int maxDepth = args.Length == 0 ? 10
                : Math.Max(MinDepth + 2, int.Parse(args[0]));

            Console.WriteLine(string.Concat("stretch tree of depth ", maxDepth + 1,
                "\t check: ", (TreeNode.bottomUpTree(maxDepth + 1)).itemCheck()));

            var longLivedTree = TreeNode.bottomUpTree(maxDepth);

            var results = new string[(maxDepth - MinDepth) / 2 + 1];

            for (int i = 0; i < results.Length; i++)
            {
                int depth = i * 2 + MinDepth;
                int n = (1 << maxDepth - depth + MinDepth) / NoTasks;
                var tasks = new Task<int>[NoTasks];
                for (int t = 0; t < tasks.Length; t++)
                {
                    tasks[t] = Task.Run(() =>
                    {
                        var check = 0;
                        for (int i = n; i > 0; i--)
                            check += (TreeNode.bottomUpTree(depth)).itemCheck();
                        return check;
                    });
                }
                var check = tasks[0].Result;
                for (int t = 1; t < tasks.Length; t++)
                    check += tasks[t].Result;
                results[i] = string.Concat(n * NoTasks, "\t trees of depth ",
                    depth, "\t check: ", check);
            }
            for (int i = 0; i < results.Length; i++)
                Console.WriteLine(results[i]);

            Console.WriteLine(string.Concat("long lived tree of depth ", maxDepth,
                "\t check: ", longLivedTree.itemCheck()));
        }

        private class TreeNode
        {
            readonly TreeNode left, right;

            internal static TreeNode bottomUpTree(int depth)
            {
                if (depth > 0) {
                    return new TreeNode(
                        bottomUpTree(depth - 1),
                            bottomUpTree(depth - 1));
                } else {
                    return new TreeNode(null,null);
                }
            }

            internal TreeNode(TreeNode left, TreeNode right)
            {
                this.left = left;
                this.right = right;
            }

            internal int itemCheck()
            {
                if (left == null) return 1;
                else return 1 + left.itemCheck() + right.itemCheck();
            }
        }
    }
arguments: [21]
framework: net9.0
compile_options:
    - -c Release
    - -p:ImplicitUsings=enable
    - -p:Nullable=enable
    - -p:AllowUnsafeBlocks=true
    - -p:ServerGarbageCollection=true
    - -p:ConcurrentGarbageCollection=true
    - -p:UseSharedCompilation=false
    - -p:OptimizationPreference=Speed
    - -p:IlcInstructionSet=native
expected_stdout: !!binary |
    c3RyZXRjaCB0cmVlIG9mIGRlcHRoIDIyCSBjaGVjazogODM4ODYwNwoyMDk3MTUyCSB0cmVlcyBv
    ZiBkZXB0aCA0CSBjaGVjazogNjUwMTE3MTIKNTI0Mjg4CSB0cmVlcyBvZiBkZXB0aCA2CSBjaGVj
    azogNjY1ODQ1NzYKMTMxMDcyCSB0cmVlcyBvZiBkZXB0aCA4CSBjaGVjazogNjY5Nzc3OTIKMzI3
    NjgJIHRyZWVzIG9mIGRlcHRoIDEwCSBjaGVjazogNjcwNzYwOTYKODE5MgkgdHJlZXMgb2YgZGVw
    dGggMTIJIGNoZWNrOiA2NzEwMDY3MgoyMDQ4CSB0cmVlcyBvZiBkZXB0aCAxNAkgY2hlY2s6IDY3
    MTA2ODE2CjUxMgkgdHJlZXMgb2YgZGVwdGggMTYJIGNoZWNrOiA2NzEwODM1MgoxMjgJIHRyZWVz
    IG9mIGRlcHRoIDE4CSBjaGVjazogNjcxMDg3MzYKMzIJIHRyZWVzIG9mIGRlcHRoIDIwCSBjaGVj
    azogNjcxMDg4MzIKbG9uZyBsaXZlZCB0cmVlIG9mIGRlcHRoIDIxCSBjaGVjazogNDE5NDMwMwo=
---
name: release

